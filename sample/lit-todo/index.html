<script type="module">
  import Replicache from './node_modules/replicache/out/mod.js';
  import {html, render} from 'https://unpkg.com/lit-html?module';

  var rep = new Replicache({
    // URL of the diff server to use. The diff server periodically fetches
    // the "client view" from your service and forwards any delta to the
    // client. You can use our hosted diff server (as here) or a local diff
    // server, which is useful during development. See
    // https://github.com/rocicorp/replicache#server-side for more
    // information on setting up your client view.
    diffServerURL: 'https://serve.replicache.dev/pull',

    // Auth token for the diff server, if any.
    diffServerAuth: '1',

    // URL of your service's Replicache batch endpoint. Replicache
    // will send batches of mutations here for application.
    batchURL: 'https://replicache-sample-todo.now.sh/serve/replicache-batch',

    // Auth token for your client view and batch endpoints, if any.
    dataLayerAuth: '2',
  });

  const updateTodo = rep.register('updateTodo', async (tx, {id, complete}) => {
    const key = `/todo/${id}`;
    const todo = await tx.get(key);
    todo.complete = complete;
    await tx.put(key, todo);
  });

  const handleCheckbox = async (id, e) => {
    await updateTodo({id, complete: e.srcElement.checked});
    rep.sync();
  };

  rep.subscribe(
    async tx => {
      return await toArray(tx.scan({prefix: '/todo/'}));
    },
    {
      onData: result => {
        // Using lit-html, but the principle is the same in any UI framework.
        // See https://github.com/rocicorp/replicache-sdk-js/tree/master/sample/cal
        // for an example using React.
        const toggle = (id, complete) =>
          html`<td>
            <input
              @change=${e => handleCheckbox(id, e)}
              type="checkbox"
              .checked=${complete}
            />
          </td>`;
        const title = text => html`<td>${text}</td>`;
        const row = todo =>
          html`<tr>
            ${toggle(todo.id, todo.complete)}${title(todo.text)}
          </tr>`;
        render(
          html`<table>
            ${result.map(row)}
          </table>`,
          document.body,
        );
      },
    },
  );

  const toArray = async iterator => {
    const arr = [];
    for await (const entry of iterator) {
      arr.push(entry);
    }
    return arr;
  };
</script>
